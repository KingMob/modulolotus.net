<div class="join mr-2" transition:persist id="theme-toggle">
  <!-- Light -->
  <button class="btn btn-sm btn-soft join-item" data-theme-value="light" aria-label="Light theme">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round">
      <circle cx="12" cy="12" r="5" />
      <path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" />
    </svg>
  </button>
  <!-- System -->
  <button class="btn btn-sm btn-soft join-item" data-theme-value="system" aria-label="System theme">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round">
      <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
      <line x1="8" y1="21" x2="16" y2="21" />
      <line x1="12" y1="17" x2="12" y2="21" />
    </svg>
  </button>
  <!-- Dark -->
  <button class="btn btn-sm btn-soft join-item" data-theme-value="dark" aria-label="Dark theme">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </button>
</div>

<script>
  function getStoredPreference(): string {
    return localStorage.getItem("theme") || "system";
  }

  function updateToggleUI() {
    const preference = getStoredPreference();
    const buttons = document.querySelectorAll('#theme-toggle button[data-theme-value]');
    buttons.forEach((btn) => {
      const value = btn.getAttribute('data-theme-value');
      if (value === preference) {
        btn.classList.remove('btn-soft');
        btn.classList.add('btn-secondary');
      } else {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-soft');
      }
    });
  }

  function setPreference(value: string) {
    if (value === "system") {
      localStorage.removeItem("theme");
    } else {
      localStorage.setItem("theme", value);
    }
    // Dispatch event for BaseHead to pick up
    window.dispatchEvent(new CustomEvent('theme-preference-changed'));
    updateToggleUI();
  }

  function initToggle() {
    const buttons = document.querySelectorAll('#theme-toggle button[data-theme-value]');
    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const value = btn.getAttribute('data-theme-value');
        if (value) {
          setPreference(value);
        }
      });
    });
    updateToggleUI();
  }

  initToggle();

  // Re-init after Astro view transitions
  document.addEventListener('astro:after-swap', () => {
    initToggle();
  });
</script>
